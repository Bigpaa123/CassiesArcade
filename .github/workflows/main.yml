name: Build Firmware and SPIFFS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        sudo mv ./bin/arduino-cli /usr/local/bin/
        arduino-cli config init
        arduino-cli core update-index

    - name: Install ESP32 Platform
      run: |
        arduino-cli core install esp32:esp32

    - name: Compile Sketch
      run: |
        mkdir -p firmware
        arduino-cli compile --fqbn esp32:esp32:esp32 --output-dir ./firmware CassiesArcade.ino

    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: ./firmware/*.bin

  build-spiffs:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y g++ git make

    - name: Clone and build mkspiffs
      run: |
        git clone --recursive https://github.com/igrr/mkspiffs.git
        cd mkspiffs
        make
        sudo cp mkspiffs /usr/local/bin/

    - name: Prepare SPIFFS folder
      run: |
        mkdir -p data
        cp -v *.html *.css *.js data/ || true

    - name: Build SPIFFS image
      run: |
        mkspiffs -c data -b 4096 -p 256 -s 0x290000 spiffs.bin

    - name: Upload SPIFFS binary
      uses: actions/upload-artifact@v4
      with:
        name: spiffs
        path: spiffs.bin
